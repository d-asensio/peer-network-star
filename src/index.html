<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minimal working example</title>
</head>
<body>
    <label>
      Peer id:
      <input id="peerIdInput" readonly type="text" />
    </label>
    
    <br />
    <br />

    <label>
      Room id:
      <input id="roomIdInput" type="text" />
    </label>
    <label>
      Is primary node:
      <input id="primaryNodeCheckbox" type="checkbox" />
    </label>
    <button id="connectButton">Connect</button>

    <br />

    <h4>Send signal</h4>
    
    <label>
      Signal:
      <input id="signalInput" type="text" />
    </label>
    <button id="sendButton">Send</button>

    <h4>Received signals</h4>

    <ul id="signalList"></ul>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const $peerIdInput = $('peerIdInput')

      const $roomIdInput = $('roomIdInput')
      const $primaryNodeCheckbox = $('primaryNodeCheckbox')
      const $connectButton = $('connectButton')

      const $signalInput = $('signalInput')
      const $sendButton = $('sendButton')

      const $signalList = $('signalList')

      $connectButton.addEventListener('click', () => {
        const connectionData = getConnectionData()

        initConnection(connectionData)
      })

      $sendButton.addEventListener('click', () => {
        sendSignal($signalInput.value)

        $signalInput.value = ''
      })

      //** DOM HELPERS **/

      function $ (elementId) {
        return document.getElementById(elementId)
      }

      function newMessageElement (content) {
        const item = document.createElement('li');
        item.innerText = content;
        return item;
      };

      function getConnectionData () {
        return {
          roomId: $roomIdInput.value,
          isPrimaryNode: $primaryNodeCheckbox.checked
        }
      }

      //** MANAGE CONNECTION **/

      let socket = null;

      function initConnection (connectionData) {
        closeConnectionIfAny()

        socket = io({
          query: connectionData
        })

        socket.on('identify', id => {
          $peerIdInput.value = id
        })

        socket.on('signal', message => {
          console.log(message)
          $signalList.append(
            newMessageElement(message)
          )
        })
      }

      function sendSignal (data) {
        socket.emit('signal', data)
      }

      function closeConnectionIfAny () {
        if (socket !== null) {
          socket.close()
        }
      }
    </script>
</body>
</html>